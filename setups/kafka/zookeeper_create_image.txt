gcloud auth login 

gcloud config set project ${project_id}

gcloud config set compute/region ${region}

gcloud compute networks create ${vpc} --subnet-mode custom

gcloud compute networks subnets create ${vpc_subnet} --network ${vpc} --range ${vpc_subnet_cidr}

gcloud compute firewall-rules create kafka-cluster-vpc-allow-kafka-zookeeper \
--description="Allow traffic between Kafka brokers and Zookeeper nodes" \
--direction=INGRESS --priority=1000 --network=${vpc} --action=ALLOW \
--rules=all --source-tags=kafka \
--target-tags=kafka

gcloud compute firewall-rules create allow-ssh-ingress-from-iap \
  --direction=INGRESS \
  --action=allow \
  --rules=tcp:22 \
  --source-ranges=35.235.240.0/20 \
  --network=${vpc}
  
gcloud compute routers create ${router_name} \
    --project=${project_id} \
    --network=${vpc} \
    --region=${region}

gcloud compute routers nats create ${nat_gateway_name} \
    --router=${router_name} \
    --region=${region} \
    --auto-allocate-nat-external-ips \
    --nat-all-subnet-ip-ranges \
    --enable-logging
  
gcloud compute instances create zk \
    --async \
    --boot-disk-size 100GB \
    --image centos-7-v20230203 \
    --image-project centos-cloud \
    --machine-type e2-small \
    --private-network-ip 10.65.0.13 \
    --scopes=https://www.googleapis.com/auth/cloud-platform \
    --subnet ${vpc_subnet} \
    --tags kafka \
    --labels=application=zookeeper \
    --zone=${region_zone_a} \
    --no-address
    
gcloud compute instances list --filter="tags.items=kafka"

gcloud beta compute ssh zk --tunnel-through-iap --zone=${region_zone_a}

sudo yum update 
sudo yum install default-jdk -y

sudo useradd zkadmin -m && sudo usermod --shell /bin/bash zkadmin
sudo passwd zkadmin
sudo usermod -aG sudo zkadmin
su -l zkadmin
sudo mkdir -p /data/zookeeper
sudo chown -R zkadmin:zkadmin /data/zookeeper
cd /opt
sudo wget https://dlcdn.apache.org/zookeeper/stable/apache-zookeeper-3.7.1-bin.tar.gz
sudo tar -xvf apache-zookeeper-3.7.1-bin.tar.gz
sudo chown zkadmin:zkadmin -R  apache-zookeeper-3.7.1-bin
sudo ln -s apache-zookeeper-3.7.1-bin zookeeper
sudo chown -h zkadmin:zkadmin /opt/zookeeper
sudo chown -R zkadmin:zkadmin /opt/zookeeper

tickTime=2000
dataDir=/data/zookeeper
clientPort=2181
initLimit=10
syncLimit=5

cd /opt/zookeeper && /opt/zookeeper/bin/zkServer.sh start

bin/zkServer.sh stop

sudo vim /etc/systemd/system/zookeeper.service

[Unit]
Description=Zookeeper Daemon
Documentation=http://zookeeper.apache.org
Requires=network.target
After=network.target

[Service]
Type=forking
WorkingDirectory=/opt/zookeeper
User=zkadmin
Group=zkadmin
ExecStart=/opt/zookeeper/bin/zkServer.sh start /opt/zookeeper/conf/zoo.cfg
ExecStop=/opt/zookeeper/bin/zkServer.sh stop /opt/zookeeper/conf/zoo.cfg
ExecReload=/opt/zookeeper/bin/zkServer.sh restart /opt/zookeeper/conf/zoo.cfg
TimeoutSec=30
Restart=on-failure

[Install]
WantedBy=default.target

gcloud beta compute machine-images \
  create zookeeper-machine-image \
  --source-instance zk \
  --source-instance-zone ${region_zone_a}
